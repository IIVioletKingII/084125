<template>
	<div class="page" data-name="connect-four">

		<div class="navbar">
			<div class="navbar-bg"></div>
			<div class="navbar-inner sliding">
				<div class="left">
					<a href="#" class="link back">
						<i class="icon icon-back"></i>
						<span class="if-not-md">Back</span>
					</a>
				</div>
				<div class="title">Connect Four Game!</div>
				<div class="right margin-right">
					<a href="#" class="button button-tonal" @click="${reset}">Reset</a>
				</div>
			</div>
		</div>

		<div class="page-content">

			<div class="winner" @click="${reset}">
				<div class="text">
					${winner} won!
				</div>
			</div>
			<div class="flex row" style="align-items: center; justify-content: center; height: 100%; height: 100%;">
				<table id="gameTable">
				</table>
			</div>
		</div>

	</div>
</template>
<style>
	#gameTable {

		width: 100%;
		height: 100%;
		border-collapse: collapse;
		table-layout: fixed;
		overflow: hidden;
	}

	.team-red,
	.red {
		--color: rgb(255, 48, 48);
	}

	.team-blue,
	.blue {
		--color: rgb(27, 61, 255);
	}

	.tile.filled {
		position: relative;
	}


	.tile.filled:after {
		content: '';
		width: 90%;
		height: 90%;
		border-radius: 50%;
		position: absolute;
		top: 5%;
		left: 5%;
		background: var(--color);
	}

	.winner {
		width: 100%;
		height: 100%;
		display: flex;
		align-items: center;
		justify-content: center;
		opacity: 0;

		font-size: 56px;
		position: absolute;
		/* background: rgba(104, 104, 104, 0.26); */
		transition: 1200ms;
		backdrop-filter: blur(3px);
		z-index: 10000;
		pointer-events: none;
	}

	th,
	td {
		border: 1px solid;
	}
</style>
<script>

	export default (props, { $, $on, $f7, $store, $update }) => {

		let turn = 'blue';
		let winner = '';
		let dim = {
			width: 7,
			height: 6
		}
		let xs = [0, 1, 1, 1];
		let ys = [1, -1, 0, 1];

		$on('pageInit', (e) => {

			createGameTable(dim.width, dim.height);
			window.addEventListener('resize', resizeGrid);
			resizeGrid();
		});

		function round(num, decimals) {
			return Math.round((num + Number.EPSILON) * Math.pow(10, decimals)) / Math.pow(10, decimals);
		}

		function resizeGrid() {
			let table = $('#gameTable');
			let parent = table.parent();
			let w = parent.width();
			let h = parent.height();
			let r = dim.width / dim.height;
			if (w / r >= h) { // wider than ration (side black bars)
				table.css('height', `${h}px`);
				table.css('width', `${h * r}px`);
			} else { //  if (tW / r >= h)
				table.css('height', `${w / r}px`);
				table.css('width', `${w}px`)
			}
		}

		function reset() {
			$('.tile.filled').removeClass('filled').removeClass('blue').removeClass('red');
			$('.winner').css('opacity', '0');
			$('.winner').css('pointer-events', 'none');
			turn = 'blue';
			winner = '';
		}

		function createGameTable(width, height) {
			$('#gameTable').html(`
				<tbody>
					${Array.from({ length: height }, (y, i) => `
					<tr>
						${Array.from({ length: width }, (x, j) => `
						<td class="tile" data-x="${j}" data-y="${i}">
							<!-- Cell ${j}, ${i} -->
						</td>
						`).join('')}
					</tr>
					`).join('')}
				</tbody>
			`);

			document.querySelector("#gameTable tbody").addEventListener("click", (event) => {
				let $td = $(event.target);
				let col = $td.data('x');
				let rows = $(`.tile:not(.filled)[data-x="${col}"]`)

				if (rows.length > 0 && turn != 'over') {

					let bottom = rows.eq(rows.length - 1)
					bottom.addClass('filled').addClass(turn);
					let curX = parseInt(bottom.data('x'));
					let curY = parseInt(bottom.data('y'));
					let win = checkWin(curX, curY)
					if (win) {
						winner = turn[0].toUpperCase() + turn.substring(1);
						$('.winner').css('opacity', '1');
						$('.winner').css('pointer-events', 'all');
						turn = 'over';
						$update();
					}
					turn = (turn == 'blue' ? 'red' : 'blue');
				}
			});
		}

		function checkWin(startX, startY) {
			for (let i = 0; i < 4; i++) {
				let x = xs[i];
				let y = ys[i];
				let connectLength = 1 + connectLengthInDir(startX, startY, x, y, 0) + connectLengthInDir(startX, startY, -x, -y, 0);

				if (connectLength >= 4)
					return true;
			}
			return false;
		}

		function connectLengthInDir(curX, curY, dirX, dirY, length) {
			// console.log('numColorsInDir', curX, curY, dirX, dirY, length);
			let testX = curX + dirX;
			let testY = curY + dirY;
			if (between(testX, 0, dim.width - 1, true) && between(testY, 0, dim.height - 1, true)) {
				let testTile = $(`.tile[data-x="${testX}"][data-y="${testY}"]`)
				// console.log('test tile', testX, testY, testTile.hasClass(turn));
				if (testTile.hasClass(turn))
					return connectLengthInDir(testX, testY, dirX, dirY, length + 1)
			}
			return length;
		}

		function between(num, min, max, inc) {
			return (inc && (num >= min && num <= max)) | (!inc && (num > min && num < max));
		}

		return $render;
	}
</script>